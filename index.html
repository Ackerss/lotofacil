import React, { useState, useEffect } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';
import { Download, Plus, Trash2, TrendingUp, Hash, Percent, Save, RefreshCw, Filter } from 'lucide-react';

const API_URL = 'https://script.google.com/macros/s/AKfycbwbeoQHQpVz9unauVFQtTVLX2hjR9vOhAcwWoqLICReKelBowYthmEyohFrAY9pq4sw6g/exec';

const LotofacilAnalyzer = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [concursos, setConcursos] = useState([]);
  const [loading, setLoading] = useState(true);
  const [frequencias, setFrequencias] = useState([]);
  const [meusJogos, setMeusJogos] = useState([]);
  const [filtroInicio, setFiltroInicio] = useState('');
  const [filtroFim, setFiltroFim] = useState('');
  
  // Configurações do gerador
  const [configGerador, setConfigGerador] = useState({
    quantPares: 7,
    somaMin: 180,
    somaMax: 220,
    repeticoesMin: 8,
    repeticoesMax: 9,
    qtdJogos: 1
  });

  useEffect(() => {
    carregarDados();
    carregarJogosSalvos();
  }, []);

  const carregarDados = async () => {
    try {
      setLoading(true);
      const response = await fetch(API_URL);
      const data = await response.json();
      
      const concursosProcessados = data.map(item => ({
        concurso: item.Concurso,
        data: item.Data,
        bolas: [
          item.B1, item.B2, item.B3, item.B4, item.B5,
          item.B6, item.B7, item.B8, item.B9, item.B10,
          item.B11, item.B12, item.B13, item.B14, item.B15
        ].filter(b => b !== undefined && b !== null)
      }));
      
      setConcursos(concursosProcessados);
      calcularFrequencias(concursosProcessados);
      setLoading(false);
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      setLoading(false);
    }
  };

  const calcularFrequencias = (dados) => {
    const freq = {};
    for (let i = 1; i <= 25; i++) {
      freq[i] = 0;
    }
    
    dados.forEach(c => {
      c.bolas.forEach(bola => {
        if (bola >= 1 && bola <= 25) {
          freq[bola]++;
        }
      });
    });
    
    const freqArray = Object.entries(freq).map(([num, count]) => ({
      numero: parseInt(num),
      frequencia: count,
      percentual: dados.length > 0 ? ((count / dados.length) * 100).toFixed(2) : 0
    })).sort((a, b) => b.frequencia - a.frequencia);
    
    setFrequencias(freqArray);
  };

  const carregarJogosSalvos = () => {
    try {
      const jogos = JSON.parse(localStorage.getItem('meusJogosLotofacil') || '[]');
      setMeusJogos(jogos);
    } catch (error) {
      console.error('Erro ao carregar jogos salvos:', error);
    }
  };

  const salvarJogo = (jogo) => {
    const novosJogos = [...meusJogos, { ...jogo, id: Date.now(), dataSalvo: new Date().toISOString() }];
    setMeusJogos(novosJogos);
    localStorage.setItem('meusJogosLotofacil', JSON.stringify(novosJogos));
  };

  const excluirJogo = (id) => {
    const novosJogos = meusJogos.filter(j => j.id !== id);
    setMeusJogos(novosJogos);
    localStorage.setItem('meusJogosLotofacil', JSON.stringify(novosJogos));
  };

  const exportarJogos = () => {
    const texto = meusJogos.map(j => 
      `Jogo ${j.id}: ${j.numeros.sort((a,b) => a-b).join(', ')}`
    ).join('\n');
    
    const blob = new Blob([texto], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'meus-jogos-lotofacil.txt';
    a.click();
  };

  const gerarJogos = () => {
    const novosJogos = [];
    const ultimoConcurso = concursos[0]?.bolas || [];
    
    for (let i = 0; i < configGerador.qtdJogos; i++) {
      let tentativas = 0;
      let jogoValido = false;
      let jogo = [];
      
      while (!jogoValido && tentativas < 1000) {
        jogo = [];
        const numerosDisponiveis = Array.from({length: 25}, (_, i) => i + 1);
        
        // Adiciona números repetidos do último concurso
        const qtdRepeticoes = Math.floor(Math.random() * 
          (configGerador.repeticoesMax - configGerador.repeticoesMin + 1)) + 
          configGerador.repeticoesMin;
        
        const numerosRepetir = [...ultimoConcurso]
          .sort(() => Math.random() - 0.5)
          .slice(0, qtdRepeticoes);
        
        jogo.push(...numerosRepetir);
        
        // Completa com números aleatórios
        while (jogo.length < 15) {
          const idx = Math.floor(Math.random() * numerosDisponiveis.length);
          const num = numerosDisponiveis[idx];
          if (!jogo.includes(num)) {
            jogo.push(num);
          }
        }
        
        jogo.sort((a, b) => a - b);
        
        // Valida regras
        const pares = jogo.filter(n => n % 2 === 0).length;
        const soma = jogo.reduce((a, b) => a + b, 0);
        
        jogoValido = 
          pares === configGerador.quantPares &&
          soma >= configGerador.somaMin &&
          soma <= configGerador.somaMax;
        
        tentativas++;
      }
      
      if (jogoValido) {
        salvarJogo({
          numeros: jogo,
          pares: jogo.filter(n => n % 2 === 0).length,
          soma: jogo.reduce((a, b) => a + b, 0),
          repeticoes: jogo.filter(n => ultimoConcurso.includes(n)).length
        });
      }
    }
  };

  const simularAcertos = (jogo) => {
    const concursosFiltrados = filtrarConcursos();
    const resultados = concursosFiltrados.map(c => {
      const acertos = jogo.numeros.filter(n => c.bolas.includes(n)).length;
      return { concurso: c.concurso, acertos };
    });
    
    const distribuicao = { 11: 0, 12: 0, 13: 0, 14: 0, 15: 0 };
    resultados.forEach(r => {
      if (r.acertos >= 11) distribuicao[r.acertos]++;
    });
    
    return { resultados, distribuicao };
  };

  const filtrarConcursos = () => {
    if (!filtroInicio && !filtroFim) return concursos;
    
    return concursos.filter(c => {
      const num = parseInt(c.concurso);
      const inicio = filtroInicio ? parseInt(filtroInicio) : 0;
      const fim = filtroFim ? parseInt(filtroFim) : Infinity;
      return num >= inicio && num <= fim;
    });
  };

  const calcularEstatisticas = () => {
    const concursosFiltrados = filtrarConcursos();
    if (concursosFiltrados.length === 0) return null;
    
    let totalPares = 0;
    let totalSoma = 0;
    
    concursosFiltrados.forEach(c => {
      totalPares += c.bolas.filter(n => n % 2 === 0).length;
      totalSoma += c.bolas.reduce((a, b) => a + b, 0);
    });
    
    return {
      mediaParesStr: (totalPares / concursosFiltrados.length).toFixed(2),
      mediaPares: totalPares / concursosFiltrados.length,
      mediaSoma: Math.round(totalSoma / concursosFiltrados.length),
      totalConcursos: concursosFiltrados.length
    };
  };

  const stats = calcularEstatisticas();

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gradient-to-br from-blue-900 to-purple-900">
        <div className="text-center">
          <RefreshCw className="w-12 h-12 text-white animate-spin mx-auto mb-4" />
          <p className="text-white text-xl">Carregando dados da Lotofácil...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-purple-900 p-4">
      <div className="max-w-7xl mx-auto">
        <header className="bg-white rounded-lg shadow-xl p-6 mb-6">
          <h1 className="text-4xl font-bold text-blue-900 mb-2">Sistema Lotofácil Pro</h1>
          <p className="text-gray-600">Análise inteligente e geração de jogos</p>
        </header>

        <div className="bg-white rounded-lg shadow-xl mb-6">
          <nav className="flex border-b overflow-x-auto">
            {[
              { id: 'dashboard', label: 'Dashboard', icon: TrendingUp },
              { id: 'frequencia', label: 'Frequências', icon: Hash },
              { id: 'gerador', label: 'Gerador', icon: Plus },
              { id: 'meus-jogos', label: 'Meus Jogos', icon: Save },
              { id: 'historico', label: 'Histórico', icon: Filter }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex items-center gap-2 px-6 py-4 font-semibold transition-colors ${
                  activeTab === tab.id
                    ? 'text-blue-600 border-b-2 border-blue-600'
                    : 'text-gray-600 hover:text-blue-600'
                }`}
              >
                <tab.icon className="w-5 h-5" />
                {tab.label}
              </button>
            ))}
          </nav>
        </div>

        {activeTab === 'dashboard' && stats && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg p-6 text-white">
                <p className="text-sm opacity-90">Total de Concursos</p>
                <p className="text-3xl font-bold mt-2">{stats.totalConcursos}</p>
              </div>
              <div className="bg-gradient-to-br from-green-500 to-green-700 rounded-lg p-6 text-white">
                <p className="text-sm opacity-90">Média de Pares</p>
                <p className="text-3xl font-bold mt-2">{stats.mediaParesStr}</p>
              </div>
              <div className="bg-gradient-to-br from-purple-500 to-purple-700 rounded-lg p-6 text-white">
                <p className="text-sm opacity-90">Soma Média</p>
                <p className="text-3xl font-bold mt-2">{stats.mediaSoma}</p>
              </div>
              <div className="bg-gradient-to-br from-orange-500 to-orange-700 rounded-lg p-6 text-white">
                <p className="text-sm opacity-90">Jogos Salvos</p>
                <p className="text-3xl font-bold mt-2">{meusJogos.length}</p>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-xl p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Top 15 Números Mais Sorteados</h2>
              <ResponsiveContainer width="100%" height={400}>
                <BarChart data={frequencias.slice(0, 15)}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="numero" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="frequencia" fill="#3B82F6" />
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div className="bg-white rounded-lg shadow-xl p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Distribuição Pares vs Ímpares</h2>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[6, 7, 8, 9].map(qtd => {
                  const ocorrencias = filtrarConcursos().filter(c => 
                    c.bolas.filter(n => n % 2 === 0).length === qtd
                  ).length;
                  const percentual = stats.totalConcursos > 0 ? 
                    ((ocorrencias / stats.totalConcursos) * 100).toFixed(1) : 0;
                  
                  return (
                    <div key={qtd} className="bg-gray-50 rounded-lg p-4 text-center">
                      <p className="text-sm text-gray-600">{qtd} Pares</p>
                      <p className="text-2xl font-bold text-blue-600">{percentual}%</p>
                      <p className="text-xs text-gray-500">{ocorrencias} vezes</p>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'frequencia' && (
          <div className="bg-white rounded-lg shadow-xl p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Frequência de Todos os Números</h2>
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
              {frequencias.map(f => (
                <div key={f.numero} className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-4 border-2 border-blue-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-3xl font-bold text-blue-900">{f.numero}</span>
                    <span className="text-sm font-semibold text-purple-600">{f.percentual}%</span>
                  </div>
                  <div className="text-sm text-gray-600">{f.frequencia} vezes</div>
                  <div className="mt-2 bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-gradient-to-r from-blue-500 to-purple-500 h-2 rounded-full" 
                      style={{ width: `${f.percentual}%` }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'gerador' && (
          <div className="space-y-6">
            <div className="bg-white rounded-lg shadow-xl p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">Configurações do Gerador</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Quantidade de Pares
                  </label>
                  <input
                    type="number"
                    min="6"
                    max="9"
                    value={configGerador.quantPares}
                    onChange={(e) => setConfigGerador({...configGerador, quantPares: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Quantidade de Jogos
                  </label>
                  <input
                    type="number"
                    min="1"
                    max="10"
                    value={configGerador.qtdJogos}
                    onChange={(e) => setConfigGerador({...configGerador, qtdJogos: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Soma Mínima
                  </label>
                  <input
                    type="number"
                    value={configGerador.somaMin}
                    onChange={(e) => setConfigGerador({...configGerador, somaMin: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Soma Máxima
                  </label>
                  <input
                    type="number"
                    value={configGerador.somaMax}
                    onChange={(e) => setConfigGerador({...configGerador, somaMax: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Repetições Mínimas (últimos concursos)
                  </label>
                  <input
                    type="number"
                    min="5"
                    max="12"
                    value={configGerador.repeticoesMin}
                    onChange={(e) => setConfigGerador({...configGerador, repeticoesMin: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Repetições Máximas (últimos concursos)
                  </label>
                  <input
                    type="number"
                    min="5"
                    max="12"
                    value={configGerador.repeticoesMax}
                    onChange={(e) => setConfigGerador({...configGerador, repeticoesMax: parseInt(e.target.value)})}
                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>
              </div>

              <button
                onClick={gerarJogos}
                className="mt-6 w-full bg-gradient-to-r from-green-500 to-green-700 text-white font-bold py-4 rounded-lg hover:from-green-600 hover:to-green-800 transition-all flex items-center justify-center gap-2"
              >
                <Plus className="w-6 h-6" />
                Gerar Jogos
              </button>
            </div>

            {concursos.length > 0 && (
              <div className="bg-white rounded-lg shadow-xl p-6">
                <h3 className="text-xl font-bold text-gray-800 mb-4">Último Concurso: {concursos[0].concurso}</h3>
                <div className="flex flex-wrap gap-3">
                  {concursos[0].bolas.map(num => (
                    <div key={num} className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-full flex items-center justify-center font-bold text-lg shadow-lg">
                      {num}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'meus-jogos' && (
          <div className="bg-white rounded-lg shadow-xl p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-gray-800">Meus Jogos Salvos</h2>
              {meusJogos.length > 0 && (
                <button
                  onClick={exportarJogos}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                >
                  <Download className="w-4 h-4" />
                  Exportar
                </button>
              )}
            </div>

            {meusJogos.length === 0 ? (
              <p className="text-center text-gray-500 py-12">Nenhum jogo salvo ainda. Use o gerador para criar jogos!</p>
            ) : (
              <div className="space-y-4">
                {meusJogos.map((jogo, idx) => {
                  const simulacao = simularAcertos(jogo);
                  const melhorAcerto = Math.max(...simulacao.resultados.map(r => r.acertos));
                  
                  return (
                    <div key={jogo.id} className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border-2 border-blue-200">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h3 className="text-lg font-bold text-gray-800">Jogo #{idx + 1}</h3>
                          <p className="text-sm text-gray-600">Salvo em {new Date(jogo.dataSalvo).toLocaleString('pt-BR')}</p>
                        </div>
                        <button
                          onClick={() => excluirJogo(jogo.id)}
                          className="text-red-500 hover:text-red-700 transition-colors"
                        >
                          <Trash2 className="w-5 h-5" />
                        </button>
                      </div>

                      <div className="flex flex-wrap gap-2 mb-4">
                        {jogo.numeros.map(num => (
                          <div key={num} className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 text-white rounded-full flex items-center justify-center font-bold shadow-lg">
                            {num}
                          </div>
                        ))}
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div className="bg-white rounded p-2">
                          <span className="text-gray-600">Pares:</span>
                          <span className="font-bold ml-2">{jogo.pares}</span>
                        </div>
                        <div className="bg-white rounded p-2">
                          <span className="text-gray-600">Soma:</span>
                          <span className="font-bold ml-2">{jogo.soma}</span>
                        </div>
                        <div className="bg-white rounded p-2">
                          <span className="text-gray-600">Repetições:</span>
                          <span className="font-bold ml-2">{jogo.repeticoes}</span>
                        </div>
                        <div className="bg-white rounded p-2">
                          <span className="text-gray-600">Melhor:</span>
                          <span className="font-bold ml-2">{melhorAcerto} acertos</span>
                        </div>
                      </div>

                      <div className="mt-4 grid grid-cols-5 gap-2 text-xs">
                        {[11, 12, 13, 14, 15].map(acertos => (
                          <div key={acertos} className="bg-white rounded p-2 text-center">
                            <div className="font-bold text-blue-600">{simulacao.distribuicao[acertos] || 0}</div>
                            <div className="text-gray-500">{acertos} pts</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {activeTab === 'historico' && (
          <div className="bg-white rounded-lg shadow-xl p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Histórico de Concursos</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Concurso Inicial
                </label>
                <input
                  type="number"
                  value={filtroInicio}
                  onChange={(e) => setFiltroInicio(e.target.value)}
                  placeholder="Ex: 3000"
                  className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Concurso Final
                </label>
                <input
                  type="number"
                  value={filtroFim}
                  onChange={(e) => setFiltroFim(e.target.value)}
                  placeholder="Ex: 3100"
                  className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                />
              </div>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
              {filtrarConcursos().slice(0, 50).map(c => (
                <div key={c.concurso} className="bg-gray-50 rounded-lg p-4">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-gray-800">Concurso {c.concurso}</span>
                    <span className="text-sm text-gray-600">{c.data}</span>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {c.bolas.map(num => (
                      <div key={num} className="w-9 h-9 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                        {num}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default LotofacilAnalyzer;
